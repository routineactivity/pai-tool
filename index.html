<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PAI Diagnostic Tool</title>

  <!-- Chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Robust CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 40px; max-width: 980px; }
    h1 { margin-bottom: 8px; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    #status { margin-top: 10px; padding: 10px; border-radius: 6px; }
    .ok { background: #eef7ee; }
    .err { background: #fdeeee; }
    #summary { font-size: 18px; margin: 18px 0; font-weight: bold; }
    canvas { margin-top: 20px; }
    button { padding: 8px 14px; cursor: pointer; }
    code { background: #f4f4f4; padding: 1px 4px; border-radius: 4px; }
  </style>
</head>

<body>
  <h1>Predictive Accuracy Index (PAI) Diagnostic</h1>
  <p>
    Upload a CSV with columns <code>unit_id</code>, <code>area</code>, <code>crime_count</code>.
    PAI per unit = (crime share) ÷ (area share).
  </p>

  <div class="row">
    <input type="file" id="csvFile" accept=".csv" />
    <button id="runBtn" disabled>Run</button>
  </div>

  <div id="status"></div>
  <div id="summary"></div>
  <canvas id="paiChart" width="900" height="420"></canvas>

<script>
  const fileInput = document.getElementById("csvFile");
  const runBtn = document.getElementById("runBtn");
  const statusEl = document.getElementById("status");
  const summaryEl = document.getElementById("summary");

  let selectedFile = null;
  let chart = null;

  function setStatus(msg, ok=true) {
    statusEl.textContent = msg;
    statusEl.className = ok ? "ok" : "err";
  }

  // normalise headers: trim, lowercase, remove BOM
  function normHeader(h) {
    return (h || "")
      .replace(/^\uFEFF/, "")     // strip BOM
      .trim()
      .toLowerCase();
  }

  // accept a few common header variants (optional but helpful)
  function findCol(headers, candidates) {
    for (const c of candidates) {
      const idx = headers.indexOf(c);
      if (idx !== -1) return idx;
    }
    return -1;
  }

  fileInput.addEventListener("change", (e) => {
    selectedFile = e.target.files[0] || null;
    runBtn.disabled = !selectedFile;
    summaryEl.textContent = "";
    if (chart) { chart.destroy(); chart = null; }
    if (selectedFile) setStatus(`Selected: ${selectedFile.name}. Click Run.`, true);
    else setStatus("", true);
  });

  runBtn.addEventListener("click", () => {
    if (!selectedFile) return;

    setStatus("Parsing CSV…", true);

    Papa.parse(selectedFile, {
      header: true,
      skipEmptyLines: true,
      dynamicTyping: true,
      complete: (results) => {
        try {
          if (results.errors && results.errors.length) {
            // show the first parse error
            throw new Error(results.errors[0].message);
          }
          processData(results.data, results.meta.fields || []);
        } catch (err) {
          setStatus(`Error: ${err.message}`, false);
        }
      }
    });
  });

  function processData(rows, fields) {
    if (!rows || !rows.length) throw new Error("No data rows found.");

    const headers = fields.map(normHeader);

    const unitIdx  = findCol(headers, ["unit_id", "unit", "id", "hex_id", "ward_id"]);
    const areaIdx  = findCol(headers, ["area", "area_m2", "area_ha", "area_sqmi", "area_km2"]);
    const crimeIdx = findCol(headers, ["crime_count", "crimes", "count", "n_crimes"]);

    if (unitIdx === -1 || areaIdx === -1 || crimeIdx === -1) {
      throw new Error(
        `Missing required columns. Found headers: ${headers.join(", ")}. ` +
        `Need: unit_id, area, crime_count (or accepted variants).`
      );
    }

    // Convert rows into clean objects
    const data = rows.map(r => {
      const raw = Object.values(r);
      return {
        unit: String(raw[unitIdx]),
        area: Number(raw[areaIdx]),
        crimes: Number(raw[crimeIdx])
      };
    }).filter(d => d.unit && Number.isFinite(d.area) && Number.isFinite(d.crimes));

    if (!data.length) throw new Error("No valid rows after reading unit/area/crime_count.");

    const totalCrimes = data.reduce((s, d) => s + d.crimes, 0);
    const totalArea   = data.reduce((s, d) => s + d.area, 0);

    if (!(totalCrimes > 0)) throw new Error("Total crime_count is 0 (or invalid).");
    if (!(totalArea > 0)) throw new Error("Total area is 0 (or invalid).");
    if (data.some(d => d.area <= 0)) throw new Error("Some rows have area <= 0.");

    data.forEach(d => {
      d.pai = (d.crimes / totalCrimes) / (d.area / totalArea);
    });

    // Sort by crimes descending (ties arbitrary)
    data.sort((a, b) => b.crimes - a.crimes);

    const paiValues = data.map(d => d.pai);
    const above10 = paiValues.filter(v => v > 10).length;

    summaryEl.textContent = `${above10} spatial units have a PAI greater than 10`;
    setStatus(`OK. Rows: ${data.length}. Total crimes: ${totalCrimes}.`, true);

    drawChart(paiValues);
  }

  function drawChart(paiValues) {
    const ctx = document.getElementById("paiChart").getContext("2d");
    if (chart) chart.destroy();

    chart = new Chart(ctx, {
      type: "line",
      data: {
        labels: paiValues.map((_, i) => i + 1),
        datasets: [
          {
            label: "PAI (ranked by crime count)",
            data: paiValues,
            borderWidth: 2,
            pointRadius: 0
          },
          {
            label: "PAI = 10",
            data: paiValues.map(() => 10),
            borderWidth: 2,
            borderDash: [6, 6],
            pointRadius: 0
          }
        ]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: true } },
        scales: {
          x: { title: { display: true, text: "Spatial units (ranked)" } },
          y: { title: { display: true, text: "Predictive Accuracy Index (PAI)" }, beginAtZero: true }
        }
      }
    });
  }
</script>
</body>
</html>

</body>
</html>
